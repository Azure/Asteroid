{"version":3,"sources":["packages/react-components/react-context-selector/src/useContextSelector.ts"],"names":[],"mappings":";;;;;;;AAAA,MAAA,iBAAA,gBAAA,OAAA,CAAA,2BAAA,CAAA;;AACA,MAAA,KAAA,gBAAA,OAAA,CAAA,OAAA,CAAA;AAaA;;;;;AAKG;;;AACI,MAAM,kBAAkB,GAAG,CAChC,OADgC,EAEhC,QAFgC,KAGf;EACjB,MAAM,YAAY,GAAG,KAAK,CAAC,UAAN,CAAkB,OAAlB,CAArB;EAEA,MAAM;IACJ,KAAK,EAAE;MAAE,OAAO,EAAE;IAAX,CADH;IAEJ,OAAO,EAAE;MAAE,OAAO,EAAE;IAAX,CAFL;IAGJ;EAHI,IAIF,YAJJ;EAKA,MAAM,QAAQ,GAAG,QAAQ,CAAC,KAAD,CAAzB;EAEA,MAAM,CAAC,KAAD,EAAQ,QAAR,IAAoB,KAAK,CAAC,UAAN,CACxB,CACE,SADF,EAEE,OAFF,KAKqC;IACnC,IAAI,CAAC,OAAL,EAAc;MACZ;MACA,OAAO,CAAC,KAAD,EAAQ,QAAR,CAAP;IACD;;IAED,IAAI,OAAO,CAAC,CAAD,CAAP,IAAc,OAAlB,EAA2B;MACzB,IAAI,QAAQ,CAAC,SAAS,CAAC,CAAD,CAAV,EAAe,QAAf,CAAZ,EAAsC;QACpC,OAAO,SAAP,CADoC,CAClB;MACnB;;MAED,OAAO,CAAC,KAAD,EAAQ,QAAR,CAAP;IACD;;IAED,IAAI;MACF,IAAI,QAAQ,CAAC,SAAS,CAAC,CAAD,CAAV,EAAe,OAAO,CAAC,CAAD,CAAtB,CAAZ,EAAwC;QACtC,OAAO,SAAP,CADsC,CACpB;MACnB;;MAED,MAAM,YAAY,GAAG,QAAQ,CAAC,OAAO,CAAC,CAAD,CAAR,CAA7B;;MAEA,IAAI,QAAQ,CAAC,SAAS,CAAC,CAAD,CAAV,EAAe,YAAf,CAAZ,EAA0C;QACxC,OAAO,SAAP,CADwC,CACtB;MACnB;;MAED,OAAO,CAAC,OAAO,CAAC,CAAD,CAAR,EAAa,YAAb,CAAP;IACD,CAZD,CAYE,OAAO,CAAP,EAAU,CACV;IACD,CA5BkC,CA8BnC;;;IACA,OAAO,CAAC,SAAS,CAAC,CAAD,CAAV,EAAe,SAAS,CAAC,CAAD,CAAxB,CAAP,CA/BmC,CA+BW;EAC/C,CAtCuB,EAuCxB,CAAC,KAAD,EAAQ,QAAR,CAvCwB,CAA1B;;EA0CA,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAD,CAAN,EAAW,QAAX,CAAb,EAAmC;IACjC;IACA;IACA,QAAQ,CAAC,SAAD,CAAR;EACD;;EAED,iBAAA,CAAA,yBAAA,CAA0B,MAAK;IAC7B,SAAS,CAAC,IAAV,CAAe,QAAf;IAEA,OAAO,MAAK;MACV,MAAM,KAAK,GAAG,SAAS,CAAC,OAAV,CAAkB,QAAlB,CAAd;MACA,SAAS,CAAC,MAAV,CAAiB,KAAjB,EAAwB,CAAxB;IACD,CAHD;EAID,CAPD,EAOG,CAAC,SAAD,CAPH;EASA,OAAO,KAAK,CAAC,CAAD,CAAZ;AACD,CAvEM;;AAAM,OAAA,CAAA,kBAAA,GAAkB,kBAAlB;AAyEb;;;AAGG;AACH;;AACA,SAAS,EAAT,CAAY,CAAZ,EAAoB,CAApB,EAA0B;EACxB,OACG,CAAC,KAAK,CAAN,KAAY,CAAC,KAAK,CAAN,IAAW,IAAI,CAAJ,KAAU,IAAI,CAArC,CAAD,IAA8C,CAAC,KAAK,CAAN,IAAW,CAAC,KAAK,CADjE,CACoE;EADpE;AAGD,C,CAED;;;AACA,MAAM,QAAQ,GACZ;AACA;AACA,OAAO,MAAM,CAAC,EAAd,KAAqB,UAArB,GAAkC,MAAM,CAAC,EAAzC,GAA8C,EAHhD","sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\n\nimport { Context, ContextSelector, ContextValue, ContextVersion } from './types';\n\n/**\n * Narrowing React.Reducer type to be more easily usable below.\n * No need to export this as it's for internal reducer usage.\n */\ntype ContextReducer<Value, SelectedValue> = React.Reducer<\n  readonly [Value, SelectedValue],\n  undefined | readonly [ContextVersion, Value]\n>;\n\n/**\n * @internal\n * This hook returns context selected value by selector.\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referencially changed.\n */\nexport const useContextSelector = <Value, SelectedValue>(\n  context: Context<Value>,\n  selector: ContextSelector<Value, SelectedValue>,\n): SelectedValue => {\n  const contextValue = React.useContext((context as unknown) as Context<ContextValue<Value>>);\n\n  const {\n    value: { current: value },\n    version: { current: version },\n    listeners,\n  } = contextValue;\n  const selected = selector(value);\n\n  const [state, dispatch] = React.useReducer<ContextReducer<Value, SelectedValue>>(\n    (\n      prevState: readonly [Value /* contextValue */, SelectedValue /* selector(value) */],\n      payload:\n        | undefined // undefined from render below\n        | readonly [ContextVersion, Value], // from provider effect\n    ): readonly [Value, SelectedValue] => {\n      if (!payload) {\n        // early bail out when is dispatched during render\n        return [value, selected] as const;\n      }\n\n      if (payload[0] <= version) {\n        if (objectIs(prevState[1], selected)) {\n          return prevState; // bail out\n        }\n\n        return [value, selected] as const;\n      }\n\n      try {\n        if (objectIs(prevState[0], payload[1])) {\n          return prevState; // do not update\n        }\n\n        const nextSelected = selector(payload[1]);\n\n        if (objectIs(prevState[1], nextSelected)) {\n          return prevState; // do not update\n        }\n\n        return [payload[1], nextSelected] as const;\n      } catch (e) {\n        // ignored (stale props or some other reason)\n      }\n\n      // explicitly spread to enforce typing\n      return [prevState[0], prevState[1]] as const; // schedule update\n    },\n    [value, selected] as const,\n  );\n\n  if (!objectIs(state[1], selected)) {\n    // schedule re-render\n    // this is safe because it's self contained\n    dispatch(undefined);\n  }\n\n  useIsomorphicLayoutEffect(() => {\n    listeners.push(dispatch);\n\n    return () => {\n      const index = listeners.indexOf(dispatch);\n      listeners.splice(index, 1);\n    };\n  }, [listeners]);\n\n  return state[1] as SelectedValue;\n};\n\n/**\n * inlined Object.is polyfill to avoid requiring consumers ship their own\n * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction is(x: any, y: any) {\n  return (\n    (x === y && (x !== 0 || 1 / x === 1 / y)) || (x !== x && y !== y) // eslint-disable-line no-self-compare\n  );\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst objectIs: (x: any, y: any) => boolean =\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore fallback to native if it exists (not in IE11)\n  typeof Object.is === 'function' ? Object.is : is;\n"],"sourceRoot":"../src/"}