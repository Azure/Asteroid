{"version":3,"file":"createContext.js","sourceRoot":"","sources":["../../../../../../../packages/react-components/react-context-selector/src/createContext.ts"],"names":[],"mappings":";;;;IAMA,IAAM,cAAc,GAAG,UAAQ,QAA6C;QAC1E,IAAM,QAAQ,GAAyC,UAAA,KAAK;YAC1D,gCAAgC;YAChC,IAAM,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAC3C,+GAA+G;YAC/G,IAAM,UAAU,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;YAEnC,gFAAgF;YAChF,IAAM,YAAY,GAAG,KAAK,CAAC,MAAM,EAAuB,CAAC;YAEzD,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE;gBACzB,YAAY,CAAC,OAAO,GAAG;oBACrB,KAAK,EAAE,QAAQ;oBACf,OAAO,EAAE,UAAU;oBACnB,SAAS,EAAE,EAAE;iBACd,CAAC;aACH;YAED,2CAAyB,CAAC;gBACxB,QAAQ,CAAC,OAAO,GAAG,KAAK,CAAC,KAAK,CAAC;gBAC/B,UAAU,CAAC,OAAO,IAAI,CAAC,CAAC;gBAExB,oCAAe,CAAC,mCAAc,EAAE;oBAC7B,YAAY,CAAC,OAA+B,CAAC,SAAS,CAAC,OAAO,CAAC,UAAA,QAAQ;wBACtE,QAAQ,CAAC,CAAC,UAAU,CAAC,OAAO,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;oBAC9C,CAAC,CAAC,CAAC;gBACL,CAAC,CAAC,CAAC;YACL,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;YAElB,OAAO,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,YAAY,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;QACxF,CAAC,CAAC;QAEF,0BAA0B;QAC1B,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY,EAAE;YACzC,QAAQ,CAAC,WAAW,GAAG,0BAA0B,CAAC;SACnD;QAED,OAAQ,QAA2D,CAAC;IACtE,CAAC,CAAC;IAEF;;OAEG;IACI,IAAM,aAAa,GAAG,UAAQ,YAAmB;QACtD,8DAA8D;QAC9D,IAAM,OAAO,GAAG,KAAK,CAAC,aAAa,CAAsB;YACvD,KAAK,EAAE,EAAE,OAAO,EAAE,YAAY,EAAE;YAChC,OAAO,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC,EAAE;YACxB,SAAS,EAAE,EAAE;SACd,CAAC,CAAC;QAEH,OAAO,CAAC,QAAQ,GAAG,cAAc,CAAQ,OAAO,CAAC,QAAQ,CAAC,CAAC;QAE3D,gCAAgC;QAChC,OAAS,OAAsC,CAAC,QAAQ,CAAC;QAEzD,OAAQ,OAAqC,CAAC;IAChD,CAAC,CAAC;IAdW,QAAA,aAAa,iBAcxB","sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\nimport { unstable_NormalPriority as NormalPriority, unstable_runWithPriority as runWithPriority } from 'scheduler';\n\nimport { Context, ContextValue } from './types';\n\nconst createProvider = <Value>(Original: React.Provider<ContextValue<Value>>) => {\n  const Provider: React.FC<React.ProviderProps<Value>> = props => {\n    // Holds an actual \"props.value\"\n    const valueRef = React.useRef(props.value);\n    // Used to sync context updates and avoid stale values, can be considered as render/effect counter of Provider.\n    const versionRef = React.useRef(0);\n\n    // A stable object, is used to avoid context updates via mutation of its values.\n    const contextValue = React.useRef<ContextValue<Value>>();\n\n    if (!contextValue.current) {\n      contextValue.current = {\n        value: valueRef,\n        version: versionRef,\n        listeners: [],\n      };\n    }\n\n    useIsomorphicLayoutEffect(() => {\n      valueRef.current = props.value;\n      versionRef.current += 1;\n\n      runWithPriority(NormalPriority, () => {\n        (contextValue.current as ContextValue<Value>).listeners.forEach(listener => {\n          listener([versionRef.current, props.value]);\n        });\n      });\n    }, [props.value]);\n\n    return React.createElement(Original, { value: contextValue.current }, props.children);\n  };\n\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== 'production') {\n    Provider.displayName = 'ContextSelector.Provider';\n  }\n\n  return (Provider as unknown) as React.Provider<ContextValue<Value>>;\n};\n\n/**\n * @internal\n */\nexport const createContext = <Value>(defaultValue: Value): Context<Value> => {\n  // eslint-disable-next-line @fluentui/no-context-default-value\n  const context = React.createContext<ContextValue<Value>>({\n    value: { current: defaultValue },\n    version: { current: -1 },\n    listeners: [],\n  });\n\n  context.Provider = createProvider<Value>(context.Provider);\n\n  // We don't support Consumer API\n  delete ((context as unknown) as Context<Value>).Consumer;\n\n  return (context as unknown) as Context<Value>;\n};\n"]}