{"version":3,"sources":["packages/react-components/react-positioning/src/usePositioning.ts"],"names":[],"mappings":"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","sourcesContent":["import { hide as hideMiddleware, arrow as arrowMiddleware } from '@floating-ui/dom';\nimport type { Middleware, Strategy } from '@floating-ui/dom';\nimport { useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\nimport { canUseDOM, useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\nimport type {\n  PositioningOptions,\n  PositioningProps,\n  PositionManager,\n  TargetElement,\n  UsePositioningReturn,\n} from './types';\nimport { useCallbackRef, toFloatingUIPlacement, hasAutofocusFilter, hasScrollParent } from './utils';\nimport {\n  shift as shiftMiddleware,\n  flip as flipMiddleware,\n  coverTarget as coverTargetMiddleware,\n  maxSize as maxSizeMiddleware,\n  offset as offsetMiddleware,\n  intersecting as intersectingMiddleware,\n} from './middleware';\nimport { createPositionManager } from './createPositionManager';\n\n/**\n * @internal\n */\nexport function usePositioning(options: UsePositioningOptions): UsePositioningReturn {\n  const managerRef = React.useRef<PositionManager | null>(null);\n  const targetRef = React.useRef<TargetElement | null>(null);\n  const overrideTargetRef = React.useRef<TargetElement | null>(null);\n  const containerRef = React.useRef<HTMLElement | null>(null);\n  const arrowRef = React.useRef<HTMLElement | null>(null);\n\n  const { enabled = true } = options;\n  const resolvePositioningOptions = usePositioningOptions(options);\n  const updatePositionManager = React.useCallback(() => {\n    if (managerRef.current) {\n      managerRef.current.dispose();\n    }\n    managerRef.current = null;\n\n    const target = overrideTargetRef.current ?? targetRef.current;\n\n    if (enabled && canUseDOM() && target && containerRef.current) {\n      managerRef.current = createPositionManager({\n        container: containerRef.current,\n        target,\n        arrow: arrowRef.current,\n        ...resolvePositioningOptions(containerRef.current, arrowRef.current),\n      });\n    }\n  }, [enabled, resolvePositioningOptions]);\n\n  const setOverrideTarget = React.useCallback(\n    (target: TargetElement | null) => {\n      overrideTargetRef.current = target;\n      updatePositionManager();\n    },\n    [updatePositionManager],\n  );\n\n  React.useImperativeHandle(\n    options.positioningRef,\n    () => ({\n      updatePosition: () => managerRef.current?.updatePosition(),\n      setTarget: (target: TargetElement) => {\n        if (options.target && process.env.NODE_ENV !== 'production') {\n          const err = new Error();\n          // eslint-disable-next-line no-console\n          console.warn('Imperative setTarget should not be used at the same time as target option');\n          // eslint-disable-next-line no-console\n          console.warn(err.stack);\n        }\n\n        setOverrideTarget(target);\n      },\n    }),\n    [options.target, setOverrideTarget],\n  );\n\n  useIsomorphicLayoutEffect(() => {\n    setOverrideTarget(options.target ?? null);\n  }, [options.target, setOverrideTarget]);\n\n  useIsomorphicLayoutEffect(() => {\n    updatePositionManager();\n  }, [updatePositionManager]);\n\n  if (process.env.NODE_ENV !== 'production') {\n    // This checked should run only in development mode\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    React.useEffect(() => {\n      if (containerRef.current) {\n        const contentNode = containerRef.current;\n        const treeWalker = contentNode.ownerDocument?.createTreeWalker(contentNode, NodeFilter.SHOW_ELEMENT, {\n          acceptNode: hasAutofocusFilter,\n        });\n\n        while (treeWalker.nextNode()) {\n          const node = treeWalker.currentNode;\n          // eslint-disable-next-line no-console\n          console.warn('<Popper>:', node);\n          // eslint-disable-next-line no-console\n          console.warn(\n            [\n              '<Popper>: ^ this node contains \"autoFocus\" prop on a React element. This can break the initial',\n              'positioning of an element and cause a window jump effect. This issue occurs because React polyfills',\n              '\"autoFocus\" behavior to solve inconsistencies between different browsers:',\n              'https://github.com/facebook/react/issues/11851#issuecomment-351787078',\n              '\\n',\n              'However, \".focus()\" in this case occurs before any other React effects will be executed',\n              '(React.useEffect(), componentDidMount(), etc.) and we can not prevent this behavior. If you really',\n              'want to use \"autoFocus\" please add \"position: fixed\" to styles of the element that is wrapped by',\n              '\"Popper\".',\n              `In general, it's not recommended to use \"autoFocus\" as it may break accessibility aspects:`,\n              'https://github.com/jsx-eslint/eslint-plugin-jsx-a11y/blob/master/docs/rules/no-autofocus.md',\n              '\\n',\n              'We suggest to use the \"trapFocus\" prop on Fluent components or a catch \"ref\" and then use',\n              '\"ref.current.focus\" in React.useEffect():',\n              'https://reactjs.org/docs/refs-and-the-dom.html#adding-a-ref-to-a-dom-element',\n            ].join(' '),\n          );\n        }\n      }\n      // We run this check once, no need to add deps here\n      // TODO: Should be rework to handle options.enabled and contentRef updates\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, []);\n  }\n\n  const setTarget = useCallbackRef<TargetElement>(null, target => {\n    if (targetRef.current !== target) {\n      targetRef.current = target;\n      updatePositionManager();\n    }\n  });\n\n  const setContainer = useCallbackRef<HTMLElement | null>(null, container => {\n    if (containerRef.current !== container) {\n      containerRef.current = container;\n      updatePositionManager();\n    }\n  });\n\n  const setArrow = useCallbackRef<HTMLElement | null>(null, arrow => {\n    if (arrowRef.current !== arrow) {\n      arrowRef.current = arrow;\n      updatePositionManager();\n    }\n  });\n\n  // Let users use callback refs so they feel like 'normal' DOM refs\n  return { targetRef: setTarget, containerRef: setContainer, arrowRef: setArrow };\n}\n\ninterface UsePositioningOptions extends PositioningProps {\n  /**\n   * If false, does not position anything\n   */\n  enabled?: boolean;\n}\n\nfunction usePositioningOptions(options: PositioningOptions) {\n  const {\n    align,\n    arrowPadding,\n    autoSize,\n    coverTarget,\n    flipBoundary,\n    offset,\n    overflowBoundary,\n    pinned,\n    position,\n    unstable_disableTether: disableTether,\n    positionFixed,\n  } = options;\n\n  const { dir } = useFluent();\n  const isRtl = dir === 'rtl';\n  const strategy: Strategy = positionFixed ? 'fixed' : 'absolute';\n\n  return React.useCallback(\n    (container: HTMLElement | null, arrow: HTMLElement | null) => {\n      const hasScrollableElement = hasScrollParent(container);\n\n      const placement = toFloatingUIPlacement(align, position, isRtl);\n      const middleware = [\n        offset && offsetMiddleware(offset),\n        coverTarget && coverTargetMiddleware(),\n        !pinned && flipMiddleware({ container, flipBoundary, hasScrollableElement }),\n        shiftMiddleware({ container, hasScrollableElement, overflowBoundary, disableTether }),\n        autoSize && maxSizeMiddleware(autoSize),\n        intersectingMiddleware(),\n        arrow && arrowMiddleware({ element: arrow, padding: arrowPadding }),\n        hideMiddleware({ strategy: 'referenceHidden' }),\n        hideMiddleware({ strategy: 'escaped' }),\n      ].filter(Boolean) as Middleware[];\n\n      return {\n        placement,\n        middleware,\n        strategy,\n      };\n    },\n    [\n      align,\n      arrowPadding,\n      autoSize,\n      coverTarget,\n      disableTether,\n      flipBoundary,\n      isRtl,\n      offset,\n      overflowBoundary,\n      pinned,\n      position,\n      strategy,\n    ],\n  );\n}\n"],"sourceRoot":"../src/"}