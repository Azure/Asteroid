{"version":3,"file":"getStyleSheetForBucket.cjs.js","sources":["../../../../packages/core/src/renderer/getStyleSheetForBucket.ts"],"sourcesContent":["import { DATA_BUCKET_ATTR } from '../constants';\nimport { GriffelRenderer, IsomorphicStyleSheet, StyleBucketName } from '../types';\nimport { createIsomorphicStyleSheet } from './createIsomorphicStyleSheet';\n\n/**\n * Ordered style buckets using their short pseudo name.\n *\n * @internal\n */\nexport const styleBucketOrdering: StyleBucketName[] = [\n  // reset styles\n  'r',\n  // catch-all\n  'd',\n  // link\n  'l',\n  // visited\n  'v',\n  // focus-within\n  'w',\n  // focus\n  'f',\n  // focus-visible\n  'i',\n  // hover\n  'h',\n  // active\n  'a',\n  // keyframes\n  'k',\n  // at-rules\n  't',\n  // @media rules\n  'm',\n];\n\n// avoid repeatedly calling `indexOf`to determine order during new insertions\nconst styleBucketOrderingMap = styleBucketOrdering.reduce((acc, cur, j) => {\n  acc[cur as StyleBucketName] = j;\n  return acc;\n}, {} as Record<StyleBucketName, number>);\n\n/**\n * Lazily adds a `<style>` bucket to the `<head>`. This will ensure that the style buckets are ordered.\n */\nexport function getStyleSheetForBucket(\n  bucketName: StyleBucketName,\n  target: Document | undefined,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): IsomorphicStyleSheet {\n  const isMediaBucket = bucketName === 'm';\n  const stylesheetKey: StyleBucketName | string = isMediaBucket ? ((bucketName + metadata['m']) as string) : bucketName;\n\n  if (!renderer.stylesheets[stylesheetKey]) {\n    const tag: HTMLStyleElement | undefined = target && target.createElement('style');\n    const stylesheet = createIsomorphicStyleSheet(tag, bucketName, {\n      ...renderer.styleElementAttributes,\n      ...(isMediaBucket && { media: metadata['m'] as string }),\n    });\n\n    renderer.stylesheets[stylesheetKey] = stylesheet;\n\n    if (target && tag) {\n      const elementSibling = findElementSibling(target, bucketName, renderer, metadata);\n      target.head.insertBefore(tag, elementSibling);\n    }\n  }\n\n  return renderer.stylesheets[stylesheetKey]!;\n}\n\n/**\n * Finds an element before which the new bucket style element should be inserted following the\n * bucket sort order\n *\n * @param target - document\n * @param targetBucket - The bucket that should be inserted to DOM\n * @param renderer - Griffel renderer\n * @param metadata - metadata for CSS rule\n * @returns - Smallest style element with greater sort order than the current bucket\n */\nfunction findElementSibling(\n  target: Document,\n  targetBucket: StyleBucketName,\n  renderer: GriffelRenderer,\n  metadata?: Record<string, unknown>,\n) {\n  const targetOrder = styleBucketOrderingMap[targetBucket];\n\n  // Similar to javascript sort comparators where\n  // a positive value is increasing sort order\n  // a negative value is decreasing sort order\n  let comparer: (el: HTMLStyleElement) => number = (el: HTMLStyleElement) =>\n    targetOrder - styleBucketOrderingMap[el.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName];\n\n  let styleElements = target.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}]`);\n\n  if (targetBucket === 'm' && metadata) {\n    const mediaElements = target.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}=\"${targetBucket}\"]`);\n    // only reduce the scope of the search and change comparer\n    // if there are other media buckets already on the page\n    if (mediaElements.length) {\n      styleElements = mediaElements;\n      comparer = (el: HTMLStyleElement) => renderer.compareMediaQueries(metadata['m'] as string, el.media);\n    }\n  }\n\n  for (const styleElement of styleElements) {\n    if (comparer(styleElement) < 0) {\n      return styleElement;\n    }\n  }\n\n  return null;\n}\n"],"names":["styleBucketOrdering","styleBucketOrderingMap","reduce","acc","cur","j","getStyleSheetForBucket","bucketName","target","renderer","metadata","isMediaBucket","stylesheetKey","stylesheets","tag","createElement","stylesheet","createIsomorphicStyleSheet","styleElementAttributes","media","elementSibling","findElementSibling","head","insertBefore","targetBucket","targetOrder","comparer","el","getAttribute","DATA_BUCKET_ATTR","styleElements","querySelectorAll","mediaElements","length","compareMediaQueries","styleElement"],"mappings":";;;;;;;AAIA;;;;;MAKaA,mBAAmB,GAAsB;AACpD;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AAGL;AACA,MAAMC,sBAAsB,gBAAGD,mBAAmB,CAACE,MAAM,CAAC,CAACC,GAAG,EAAEC,GAAG,EAAEC,CAAC;EACpEF,GAAG,CAACC,GAAsB,CAAC,GAAGC,CAAC;EAC/B,OAAOF,GAAG;AACZ,CAAC,EAAE,EAAqC,CAAC;AAEzC;;;SAGgBG,sBAAsB,CACpCC,UAA2B,EAC3BC,MAA4B,EAC5BC,QAAyB,EACzBC,WAAoC,EAAE;EAEtC,MAAMC,aAAa,GAAGJ,UAAU,KAAK,GAAG;EACxC,MAAMK,aAAa,GAA6BD,aAAa,GAAKJ,UAAU,GAAGG,QAAQ,CAAC,GAAG,CAAC,GAAeH,UAAU;EAErH,IAAI,CAACE,QAAQ,CAACI,WAAW,CAACD,aAAa,CAAC,EAAE;IACxC,MAAME,GAAG,GAAiCN,MAAM,IAAIA,MAAM,CAACO,aAAa,CAAC,OAAO,CAAC;IACjF,MAAMC,UAAU,GAAGC,qDAA0B,CAACH,GAAG,EAAEP,UAAU,kCACxDE,QAAQ,CAACS,sBAAsB,GAC9BP,aAAa,IAAI;MAAEQ,KAAK,EAAET,QAAQ,CAAC,GAAG;KAAa,EACvD;IAEFD,QAAQ,CAACI,WAAW,CAACD,aAAa,CAAC,GAAGI,UAAU;IAEhD,IAAIR,MAAM,IAAIM,GAAG,EAAE;MACjB,MAAMM,cAAc,GAAGC,kBAAkB,CAACb,MAAM,EAAED,UAAU,EAAEE,QAAQ,EAAEC,QAAQ,CAAC;MACjFF,MAAM,CAACc,IAAI,CAACC,YAAY,CAACT,GAAG,EAAEM,cAAc,CAAC;;;EAIjD,OAAOX,QAAQ,CAACI,WAAW,CAACD,aAAa,CAAE;AAC7C;AAEA;;;;;;;;;;AAUA,SAASS,kBAAkB,CACzBb,MAAgB,EAChBgB,YAA6B,EAC7Bf,QAAyB,EACzBC,QAAkC;EAElC,MAAMe,WAAW,GAAGxB,sBAAsB,CAACuB,YAAY,CAAC;;;;EAKxD,IAAIE,QAAQ,GAAsCC,EAAoB,IACpEF,WAAW,GAAGxB,sBAAsB,CAAC0B,EAAE,CAACC,YAAY,CAACC,0BAAgB,CAAoB,CAAC;EAE5F,IAAIC,aAAa,GAAGtB,MAAM,CAACc,IAAI,CAACS,gBAAgB,KAAuBF,6BAAmB,CAAC;EAE3F,IAAIL,YAAY,KAAK,GAAG,IAAId,QAAQ,EAAE;IACpC,MAAMsB,aAAa,GAAGxB,MAAM,CAACc,IAAI,CAACS,gBAAgB,KAAuBF,+BAAqBL,gBAAgB,CAAC;;;IAG/G,IAAIQ,aAAa,CAACC,MAAM,EAAE;MACxBH,aAAa,GAAGE,aAAa;MAC7BN,QAAQ,GAAIC,EAAoB,IAAKlB,QAAQ,CAACyB,mBAAmB,CAACxB,QAAQ,CAAC,GAAG,CAAW,EAAEiB,EAAE,CAACR,KAAK,CAAC;;;EAIxG,KAAK,MAAMgB,YAAY,IAAIL,aAAa,EAAE;IACxC,IAAIJ,QAAQ,CAACS,YAAY,CAAC,GAAG,CAAC,EAAE;MAC9B,OAAOA,YAAY;;;EAIvB,OAAO,IAAI;AACb;;;;;"}